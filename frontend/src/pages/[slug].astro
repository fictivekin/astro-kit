---
import Layout from "../layouts/Layout.astro";
import { sanityClient } from "../lib/sanity";
import { componentMap } from "../lib/componentMap";
import { fetchPageBySlug } from "../lib/queries";

// Get all pages for static generation
export async function getStaticPaths() {
  const pages = await sanityClient.fetch(
    `*[_type == "page" && defined(slug.current)] {
      "slug": slug.current
    }`
  );

  return pages.map((page: any) => ({
    params: { slug: page.slug },
  }));
}

const { slug } = Astro.params;

const page = await fetchPageBySlug(slug);

// Return 404 if page not found
if (!page) {
  return Astro.redirect("/404");
}
---

<Layout>
  {
    page?.sections?.map((section: any) => {
      const Component = componentMap[section._type];

      if (Component) {
        return <Component {...{ [section._type]: section }} />;
      }

      // Fallback for sections without a component
      return <div>No component for: {section._type}</div>;
    })
  }
</Layout>
