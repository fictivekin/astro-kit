---
import Layout from "@/layouts/Layout.astro";
import Media from "@/components/elements/Media/Media.astro";
import PostCard from "@/components/elements/PostCard/PostCard.astro";
import { PortableText } from "astro-portabletext";
import { getCollection } from "astro:content";
import { fetchPostBySlug } from "@/lib/queries/post";

export const prerender = true;

// Get all posts for static generation
export async function getStaticPaths() {
  const posts = await getCollection("posts");

  return posts.map((post: any) => ({
    params: { slug: post.id },
  }));
}

const { slug } = Astro.params;

// Fetch full post data including body
const postData = await fetchPostBySlug(slug);

// Return 404 if post not found
if (!postData) {
  return Astro.redirect("/404");
}

// Format the publish date
const formattedDate = postData.publishedOn
  ? new Date(postData.publishedOn).toLocaleDateString("en-US", {
      year: "numeric",
      month: "long",
      day: "numeric",
    })
  : "";

// Calculate reading time (rough estimate: 200 words per minute)
const calculateReadingTime = (body: any) => {
  if (!body) return 0;
  const text = JSON.stringify(body);
  const wordCount = text.split(/\s+/).length;
  return Math.ceil(wordCount / 200);
};

const readingTime = postData.showReadingTime
  ? calculateReadingTime(postData.body)
  : null;

// Prepare SEO data with fallbacks
const seoTitle = postData.seoTitle || postData.title;
const seoDescription =
  postData.seoDescription || postData.thumbnailText || undefined;
const seoNoIndex = postData.noIndex ?? undefined;

// Prepare OG/Social image - prefer social image, fallback to hero image
const seoImage =
  postData.socialImage?.asset?.url ||
  postData.heroImage?.asset?.url ||
  undefined;
const seoImageAlt =
  postData.socialImageAlt ||
  postData.socialImage?.altText ||
  postData.heroImage?.altText ||
  undefined;
---

<Layout
  title={seoTitle}
  description={seoDescription}
  noIndex={seoNoIndex}
  image={seoImage}
  imageAlt={seoImageAlt}
  ogType="article"
>
  <article class="post">
    {
      postData.heroImage && (
        <div class="post__hero">
          <Media media={{ type: "image", image: postData.heroImage }} />
        </div>
      )
    }

    <div class="post__container">
      <header class="post__header">
        {
          postData.topics && postData.topics.length > 0 && (
            <div class="post__topics">
              {postData.topics.map((topic) => (
                <a
                  href={`/resources/topic/${topic.slug.current}`}
                  class="post__topic"
                >
                  {topic.title}
                </a>
              ))}
            </div>
          )
        }

        <h1 class="post__title">{postData.title}</h1>

        <div class="post__meta">
          {
            formattedDate && (
              <time class="post__date" datetime={postData.publishedOn}>
                {formattedDate}
              </time>
            )
          }
          {
            readingTime && (
              <span class="post__reading-time">{readingTime} min read</span>
            )
          }
        </div>

        {
          postData.author && postData.author.length > 0 && (
            <div class="post__authors">
              {postData.author.map((author) => (
                <div class="post__author">
                  {author.photo && (
                    <div class="post__author-photo">
                      <Media media={{ type: "image", image: author.photo }} />
                    </div>
                  )}
                  <div class="post__author-info">
                    <div class="post__author-name">{author.name}</div>
                    {(author.position || author.company) && (
                      <div class="post__author-title">
                        {[author.position, author.company]
                          .filter(Boolean)
                          .join(" at ")}
                      </div>
                    )}
                  </div>
                </div>
              ))}
            </div>
          )
        }
      </header>

      {
        postData.body && postData.body.length > 0 && (
          <div class="post__body">
            <PortableText value={postData.body} />
          </div>
        )
      }

      {
        postData.showRelatedPosts &&
          postData.relatedPosts &&
          postData.relatedPosts.length > 0 && (
            <section class="post__related">
              <h2 class="post__related-title">Related Posts</h2>
              <div class="post__related-grid">
                {postData.relatedPosts.map((relatedPost) => (
                  <PostCard post={relatedPost} />
                ))}
              </div>
            </section>
          )
      }
    </div>
  </article>
</Layout>

<style>
  .post {
    width: 100%;
  }

  .post__hero {
    width: 100%;
    max-height: 600px;
    overflow: hidden;
    background: #f0f0f0;
  }

  .post__hero :global(img) {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .post__container {
    max-width: 800px;
    margin: 0 auto;
    padding: 3rem 1.5rem;
  }

  .post__header {
    margin-bottom: 3rem;
  }

  .post__topics {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
  }

  .post__topic {
    display: inline-block;
    padding: 0.5rem 1rem;
    background: #eef2ff;
    color: #6366f1;
    font-size: 0.875rem;
    font-weight: 600;
    text-decoration: none;
    border-radius: 4px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    transition: background 0.2s ease;
  }

  .post__topic:hover {
    background: #ddd6fe;
  }

  .post__title {
    margin: 0 0 1.5rem;
    font-size: 2.5rem;
    font-weight: 800;
    line-height: 1.2;
    color: #1f2937;
  }

  .post__meta {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    align-items: center;
    font-size: 1rem;
    color: #6b7280;
    margin-bottom: 2rem;
  }

  .post__date {
    font-weight: 500;
  }

  .post__reading-time {
    padding-left: 1rem;
    border-left: 2px solid #e5e7eb;
  }

  .post__authors {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .post__author {
    display: flex;
    gap: 1rem;
    align-items: center;
  }

  .post__author-photo {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    overflow: hidden;
    flex-shrink: 0;
    background: #f0f0f0;
  }

  .post__author-photo :global(img) {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .post__author-name {
    font-size: 1.125rem;
    font-weight: 700;
    color: #1f2937;
  }

  .post__author-title {
    font-size: 0.875rem;
    color: #6b7280;
  }

  .post__body {
    font-size: 1.125rem;
    line-height: 1.8;
    color: #374151;
    margin-bottom: 4rem;
  }

  .post__body :global(h2) {
    margin-top: 3rem;
    margin-bottom: 1.5rem;
    font-size: 2rem;
    font-weight: 700;
    color: #1f2937;
  }

  .post__body :global(h3) {
    margin-top: 2.5rem;
    margin-bottom: 1rem;
    font-size: 1.5rem;
    font-weight: 700;
    color: #1f2937;
  }

  .post__body :global(p) {
    margin-bottom: 1.5rem;
  }

  .post__body :global(ul),
  .post__body :global(ol) {
    margin-bottom: 1.5rem;
    padding-left: 1.5rem;
  }

  .post__body :global(li) {
    margin-bottom: 0.5rem;
  }

  .post__body :global(a) {
    color: #6366f1;
    text-decoration: underline;
  }

  .post__body :global(a:hover) {
    color: #4f46e5;
  }

  .post__body :global(img) {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    margin: 2rem 0;
  }

  .post__body :global(blockquote) {
    margin: 2rem 0;
    padding-left: 1.5rem;
    border-left: 4px solid #6366f1;
    font-style: italic;
    color: #4b5563;
  }

  .post__body :global(code) {
    background: #f3f4f6;
    padding: 0.2rem 0.4rem;
    border-radius: 4px;
    font-size: 0.9em;
    font-family: "Courier New", monospace;
  }

  .post__body :global(pre) {
    background: #1f2937;
    color: #f3f4f6;
    padding: 1.5rem;
    border-radius: 8px;
    overflow-x: auto;
    margin: 2rem 0;
  }

  .post__body :global(pre code) {
    background: none;
    padding: 0;
    color: inherit;
  }

  .post__related {
    padding-top: 4rem;
    border-top: 2px solid #e5e7eb;
  }

  .post__related-title {
    margin: 0 0 2rem;
    font-size: 2rem;
    font-weight: 700;
    color: #1f2937;
  }

  .post__related-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 2rem;
  }

  @media (min-width: 768px) {
    .post__title {
      font-size: 3rem;
    }

    .post__container {
      padding: 4rem 2rem;
    }

    .post__related-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (min-width: 1024px) {
    .post__related-grid {
      grid-template-columns: repeat(4, 1fr);
    }
  }
</style>
