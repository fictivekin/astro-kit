---
import Layout from "@/layouts/Layout.astro";
import PostLayout from "@/components/PostLayout.astro";
import { getCollection } from "astro:content";
import { fetchPostBySlug } from "@/lib/queries/post";

export const prerender = true;

// Get all posts for static generation
export async function getStaticPaths() {
  const posts = await getCollection("posts");

  return posts.map((post: any) => ({
    params: { slug: post.id },
  }));
}

const { slug } = Astro.params;

// Fetch full post data including body
const postData = await fetchPostBySlug(slug);

// Return 404 if post not found
if (!postData) {
  return Astro.redirect("/404");
}

// Prepare SEO data with fallbacks
const seoTitle = postData.seoTitle || postData.title;
const seoDescription =
  postData.seoDescription || postData.thumbnailText || undefined;
const seoNoIndex = postData.noIndex ?? undefined;

// Prepare OG/Social image - prefer social image, fallback to hero image
const seoImage =
  postData.socialImage?.asset?.url ||
  postData.heroImage?.asset?.url ||
  undefined;
const seoImageAlt =
  postData.socialImageAlt ||
  postData.socialImage?.altText ||
  postData.heroImage?.altText ||
  undefined;
---

<Layout
  title={seoTitle}
  description={seoDescription}
  noIndex={seoNoIndex}
  image={seoImage}
  imageAlt={seoImageAlt}
  ogType="article"
>
  <PostLayout postData={postData} />
</Layout>
